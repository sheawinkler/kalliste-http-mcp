.RECIPEPREFIX := >
SHELL := /bin/bash
COMPOSE := docker compose
MEM_FILES := \
  -f infra/compose/docker-compose.qdrant.port.yml
MEM_FILES := \
  -f docker-compose.yml \
  -f docker-compose.override.http.yml \
  -f docker-compose.override.vols.yml \
  -f docker-compose.override.stackfix.yml \
  -f docker-compose.mcp-qdrant.http.yml \
  -f docker-compose.memorymcp-http.build.yml \
  -f docker-compose.mcp-proxy.yml \
  -f docker-compose.mindsdb.yml \
  -f docker-compose.mindsdb-http-proxy.yml \
  -f docker-compose.mindsdb.volumes.yml \
  -f docker-compose.volumes.fix.yml \
  -f docker-compose.disable.legacy.yml \
  -f docker-compose.memorymcp-http.cmdforce.yml \
  -f docker-compose.mcp-proxy.depfix.yml \
  -f docker-compose.health.disable.yml

.PHONY: mem-up
mem-up:
> $(COMPOSE) $(MEM_FILES) up -d --remove-orphans
> @$(COMPOSE) $(MEM_FILES) ps

.PHONY: mem-restart
mem-restart:
> $(COMPOSE) $(MEM_FILES) up -d --force-recreate --remove-orphans

.PHONY: mem-down
mem-down:
> $(COMPOSE) $(MEM_FILES) down

.PHONY: mem-ps
mem-ps:
> $(COMPOSE) $(MEM_FILES) ps

.PHONY: mem-logs
mem-logs:
> $(COMPOSE) $(MEM_FILES) logs -f --tail=200

MEM_FILES += \
  -f docker-compose.memorymcp-http.port.yml

.PHONY: mem-smoke
.PHONY: mem
mem: mem-restart mem-smoke mem-ps mem-logs-short

.PHONY: mem-smoke
mem-smoke:
> @echo "→ MCP /mcp POST ping (expect 200/204/404 but not connection refused)"
> @curl -sS -o /dev/null -w "%{http_code}\n" \
>   -H 'accept: application/json' -H 'content-type: application/json' \
>   -d '{"jsonrpc":"2.0","id":"ping","method":"ping","params":{}}' \
>   http://127.0.0.1:59081/mcp || true
> @echo "→ mcp-proxy :9090 (expect HTTP/1.1 line)"
> @curl -sS -o /dev/null -D - http://127.0.0.1:9090/ | head -n 1 || true

.PHONY: mem-logs-short
mem-logs-short:
> @$(COMPOSE) $(MEM_FILES) logs --tail=60 memorymcp-http

.PHONY: mem-status
mem-status:
> @$(COMPOSE) $(MEM_FILES) ps
> @for s in memorymcp-http mcp-qdrant mindsdb-http-proxy mcp-proxy; do \
>   cid="$$(docker ps -q --filter label=com.docker.compose.service=$$s)"; \
>   if [ -n "$$cid" ]; then \
>     echo "=== $$s :: files ==="; \
>     docker inspect -f '{{json .Config.Labels}}' "$$cid" | jq -r '."com.docker.compose.config-files"'; \
>   fi; \
> done

MEM_FILES += \
  -f docker-compose.memorymcp-http.debug.yml

MEM_FILES += \
  -f docker-compose.memorymcp-http.cmd.yml
# --- MCP HTTP-only config (standardized to /mcp/) ---
MCP_URL_8011 ?= http://127.0.0.1:8011/mcp/
MCP_VER      ?= 2025-06-18
MCP_ACCEPT   ?= application/json

.PHONY: mem-ping
.PHONY: mem
mem: mem-restart mem-ping mem-ps mem-logs-short

override MCP_ACCEPT := application/json, text/event-stream

# --- MCP HTTP-only standard (no stdio, no SSE opens) ---
override MCP_URL_8011 := http://127.0.0.1:8011/mcp/
override MCP_VER      := 2025-06-18
override MCP_ACCEPT   := application/json, text/event-stream
override MCP_CLIENT_NAME := kalliste-alpha
override MCP_CLIENT_VER  := dev

.PHONY: mem-ping
mem-ping:
> @echo "→ initialize ($(MCP_URL_8011))"
> @b=$$(mktemp -t mcp_init.XXXX.json); \
> c=$$(curl -sS -w '%{http_code}' -o $$b \
>   -H 'accept: $(MCP_ACCEPT)' \
>   -H 'content-type: application/json' \
>   -H 'MCP-Protocol-Version: $(MCP_VER)' \
>   -d "{\"jsonrpc\":\"2.0\",\"id\":\"init-1\",\"method\":\"initialize\",\"params\":{\"protocolVersion\":\"$(MCP_VER)\",\"clientInfo\":{\"name\":\"$(MCP_CLIENT_NAME)\",\"version\":\"$(MCP_CLIENT_VER)\"}}}" \
>   $(MCP_URL_8011)); \
> echo "HTTP $$c"; \
> (jq -C . $$b 2>/dev/null || cat $$b); rm -f $$b
> @echo "→ tools/list"
> @b=$$(mktemp -t mcp_tools.XXXX.json); \
> c=$$(curl -sS -w '%{http_code}' -o $$b \
>   -H 'accept: $(MCP_ACCEPT)' \
>   -H 'content-type: application/json' \
>   -H 'MCP-Protocol-Version: $(MCP_VER)' \
>   -d '{"jsonrpc":"2.0","id":"tools-1","method":"tools/list","params":{}}' \
>   $(MCP_URL_8011)); \
> echo "HTTP $$c"; \
> (jq -C . $$b 2>/dev/null || cat $$b); rm -f $$b
# MAKE-END-MEM-PING

MEM_FILES += \
  -f docker-compose.health.memorymcp-http.node.yml

MEM_FILES := \
  -f infra/compose/docker-compose.yml \
  -f infra/compose/docker-compose.override.http.yml \
  -f infra/compose/docker-compose.override.vols.yml \
  -f infra/compose/docker-compose.override.stackfix.yml \
  -f infra/compose/docker-compose.mcp-qdrant.http.yml \
  -f infra/compose/docker-compose.memorymcp-http.build.yml \
  -f infra/compose/docker-compose.mcp-proxy.yml \
  -f infra/compose/docker-compose.mindsdb.yml \
  -f infra/compose/docker-compose.mindsdb-http-proxy.yml \
  -f infra/compose/docker-compose.mindsdb.volumes.yml \
  -f infra/compose/docker-compose.volumes.fix.yml \
  -f infra/compose/docker-compose.disable.legacy.yml \
  -f infra/compose/docker-compose.health.memorymcp-http.node.yml \
  -f infra/compose/docker-compose.mcp-proxy.depfix.yml
